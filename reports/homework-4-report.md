# Лента постов
## Формат
Для хранения ленты используется Redis.

Формат хранения ленты:
   ключ -- ID пользователя, для которого формируется лента
   значение -- LIST из постов ленты, каждый пост это JSON

## Принцип обновления
Обновление ленты состоит из трёх этапов:
1. Создание поста
2. Подготовка списка лент для обновления
3. Обновление лент в кэше по списку

Этапы 2 и 3 проходят асинхронно, не блокируя пользователю работу с бэкэндом.
Асинхронность реализуется двумя фоновыми горутинами: cacheSubPrepareFeedUpdate() и cacheSubFeedUpdate(), отвечающими за каждый из этапов соответственно.
Обмен сообщениями между ними осуществляется с помощью pub/sub каналов того же самого Redis. Таким образом отсутствует необходимость в отдельном сервисе очередей.

### Создание поста
После создания поста формируется сообщение в канал feedUpdatePrepare с ID поста и ID автора.

### Подготовка списка лент
Это сообщение получается первой фоновой горутиной cacheSubPrepareFeedUpdate(). Она по ID автора достаёт из базы список ID пользователей, подписанных на автора (тех, кто добавил его в друзья). Этот список делится на порции, размером feedUpdateBatchSize (по умолчанию и для простоты равным 10) каждая. Горутина формирует сообщение в канал feedUpdate с ID поста и массивом ID пользователей.

### Обновление лент
Это сообщение получается второй фоновой горутиной cacheSubFeedUpdate(). Она достаёт пост из базы по его ID и проходит в цикле по массивом ID пользователей. Для каждого из них (а это ключ в кэше):
- выполняется LPUSH поста, чтобы он полявился на первом месте списка
- запрашивается LLEN списка, чтобы узнать его новый размер
- если LLEN больше feedSize (по умолчанию и для простоты равным 10), то выполняется RPOP списка до тех пор, пока LLEN не будет равен feedSize, чтобы удалить наиболее старые посты из фида
Таким образом в ленте в кэше всегда остаётся feedSize наиболее свежих постов друзей.

## Перестройка кэша из БД
Посажена на отдельный урл. Реализована "в лоб" двумя циклами:
- по пользователям с друзьями
- по feedSize последним постам всех друзей пользователя
Очень затратна на больших объёмах. Как вариант дальнейшего развития, её стоит тоже сделать асинхронной.
